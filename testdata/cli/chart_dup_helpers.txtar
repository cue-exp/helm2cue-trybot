# Chart with duplicate helper definitions across main chart and subchart.
# Reproduces the scenario seen in charts like kube-prometheus-stack
# where vendored subcharts redefine the same helpers.
exec helm2cue chart chartdir outdir
stderr 'converted 1/1 templates'
cmp outdir/helpers.cue expected/helpers.cue
cmp outdir/values.cue expected/values.cue
cmp outdir/deployment.cue expected/deployment.cue

-- chartdir/Chart.yaml --
apiVersion: v2
name: dup-helpers
description: Chart with duplicate helper definitions across subcharts
version: 0.1.0
appVersion: "1.0.0"
-- chartdir/values.yaml --
replicaCount: 1
image: "nginx:latest"
-- chartdir/templates/_helpers.tpl --
{{- define "dup-helpers.name" -}}
{{- .Chart.Name | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{- define "dup-helpers.labels" -}}
app.kubernetes.io/name: {{ include "dup-helpers.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end -}}
-- chartdir/charts/subchart/templates/_helpers.tpl --
{{- define "dup-helpers.name" -}}
{{- .Chart.Name | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{- define "dup-helpers.labels" -}}
app.kubernetes.io/name: {{ include "dup-helpers.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end -}}
-- chartdir/templates/deployment.yaml --
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "dup-helpers.name" . }}
  labels:
    {{- include "dup-helpers.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  template:
    spec:
      containers:
        - name: {{ include "dup-helpers.name" . }}
          image: {{ .Values.image }}
-- expected/helpers.cue --
// Code generated by helm2cue; DO NOT EDIT.

package dup_helpers

import "strings"

// _trunc truncates a string to N runes, matching Helm's
// trunc semantics where shorter strings pass through.
// A natural candidate for a CUE standard library builtin.
_trunc: {
	#in: string
	#n:  int
	_r:  len(strings.Runes(#in))
	out: string
	if _r <= #n {out: #in}
	if _r > #n {out: strings.SliceRunes(#in, 0, #n)}
}

_dup_helpers_labels: {
	"app.kubernetes.io/name":     _dup_helpers_name
	"app.kubernetes.io/instance": #release.Name
}
_dup_helpers_name: {
	strings.TrimSuffix((_trunc & {#in: #chart.Name, #n: 63}).out, "-")
}
-- expected/values.cue --
// Code generated by helm2cue; DO NOT EDIT.

package dup_helpers

#values: {
	replicaCount!: bool | number | string | null
	image!:        bool | number | string | null
	...
}
-- expected/deployment.cue --
// Code generated by helm2cue; DO NOT EDIT.

package dup_helpers

deployment: {
	apiVersion: "apps/v1"
	kind:       "Deployment"
	metadata: {
		name:   _dup_helpers_name
		labels: _dup_helpers_labels
	}
	spec: {
		replicas: #values.replicaCount
		template: {
			spec: {
				containers: [
					{
						name:  _dup_helpers_name
						image: #values.image
					},
				]
			}
		}
	}
}
