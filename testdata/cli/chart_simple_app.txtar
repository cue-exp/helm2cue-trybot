# Convert a simple Helm chart to CUE and verify golden output.
exec helm2cue chart chartdir outdir
stderr 'converted 3/3 templates'
cmp outdir/cue.mod/module.cue expected/cue.mod/module.cue
cmp outdir/helpers.cue expected/helpers.cue
cmp outdir/values.cue expected/values.cue
cmp outdir/data.cue expected/data.cue
cmp outdir/context.cue expected/context.cue
cmp outdir/deployment.cue expected/deployment.cue
cmp outdir/service.cue expected/service.cue
cmp outdir/configmap.cue expected/configmap.cue
cmp outdir/results.cue expected/results.cue
cmp outdir/values.yaml expected/values.yaml
cmp outdir/release.yaml expected/release.yaml

-- chartdir/Chart.yaml --
apiVersion: v2
name: simple-app
description: A simple application chart
version: 0.1.0
appVersion: "1.0.0"
-- chartdir/values.yaml --
replicaCount: 3

image:
  repository: nginx
  tag: "1.25"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 80

ports:
  - name: http
    containerPort: 80
  - name: https
    containerPort: 443

env: production
debug: false
-- chartdir/templates/_helpers.tpl --
{{- define "simple-app.name" -}}
{{- .Chart.Name | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{- define "simple-app.fullname" -}}
{{- printf "%s-%s" .Release.Name .Chart.Name | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{- define "simple-app.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{- define "simple-app.labels" -}}
helm.sh/chart: {{ include "simple-app.chart" . }}
app.kubernetes.io/name: {{ include "simple-app.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
app.kubernetes.io/managed-by: Helm
{{- end -}}

{{- define "simple-app.selectorLabels" -}}
app.kubernetes.io/name: {{ include "simple-app.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end -}}
-- chartdir/templates/deployment.yaml --
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "simple-app.fullname" . }}
  labels:
    {{- include "simple-app.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount | default 1 }}
  selector:
    matchLabels:
      {{- include "simple-app.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "simple-app.selectorLabels" . | nindent 8 }}
    spec:
      containers:
        - name: {{ include "simple-app.name" . }}
          image: {{ printf "%s:%s" .Values.image.repository .Values.image.tag }}
          imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
          ports:
            {{- range .Values.ports }}
            - name: {{ .name }}
              containerPort: {{ .containerPort }}
            {{- end }}
-- chartdir/templates/service.yaml --
apiVersion: v1
kind: Service
metadata:
  name: {{ include "simple-app.fullname" . }}
  labels:
    {{- include "simple-app.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type | default "ClusterIP" }}
  ports:
    - port: {{ .Values.service.port | default 80 }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "simple-app.selectorLabels" . | nindent 4 }}
-- chartdir/templates/configmap.yaml --
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "simple-app.fullname" . }}
  labels:
    {{- include "simple-app.labels" . | nindent 4 }}
data:
  environment: {{ .Values.env | default "development" | quote }}
  {{- if .Values.debug }}
  logLevel: "debug"
  {{- else }}
  logLevel: "info"
  {{- end }}
-- expected/cue.mod/module.cue --
// Code generated by helm2cue; DO NOT EDIT.

module: "helm.local/simple-app"
language: {
	version: "v0.16.0"
}
-- expected/helpers.cue --
// Code generated by helm2cue; DO NOT EDIT.

package simple_app

import (
	"strings"
	"struct"
)

// _nonzero tests whether a value is "truthy" (non-zero,
// non-empty, non-null), matching Go text/template semantics.
// A natural candidate for a CUE standard library builtin.
_nonzero: {
	#arg?: _
	[if #arg != _|_ {
		[
			if (#arg & int) != _|_ {#arg != 0},
			if (#arg & string) != _|_ {#arg != ""},
			if (#arg & float) != _|_ {#arg != 0.0},
			if (#arg & bool) != _|_ {#arg},
			if (#arg & [...]) != _|_ {len(#arg) > 0},
			if (#arg & {...}) != _|_ {(#arg & struct.MaxFields(0)) == _|_},
			false,
		][0]
	}, false][0]
}

// _trunc truncates a string to N runes, matching Helm's
// trunc semantics where shorter strings pass through.
// A natural candidate for a CUE standard library builtin.
_trunc: {
	#in: string
	#n:  int
	_r:  len(strings.Runes(#in))
	out: string
	if _r <= #n {out: #in}
	if _r > #n {out: strings.SliceRunes(#in, 0, #n)}
}

_simple_app_chart: {
	strings.TrimSuffix((_trunc & {#in: strings.Replace("\(#chart.Name)-\(#chart.Version)", "+", "_", -1), #n: 63}).out, "-")
}
_simple_app_fullname: {
	strings.TrimSuffix((_trunc & {#in: "\(#release.Name)-\(#chart.Name)", #n: 63}).out, "-")
}
_simple_app_labels: {
	"helm.sh/chart":                _simple_app_chart
	"app.kubernetes.io/name":       _simple_app_name
	"app.kubernetes.io/instance":   #release.Name
	"app.kubernetes.io/version":    "\(#chart.AppVersion)"
	"app.kubernetes.io/managed-by": "Helm"
}
_simple_app_name: {
	strings.TrimSuffix((_trunc & {#in: #chart.Name, #n: 63}).out, "-")
}
_simple_app_selectorLabels: {
	"app.kubernetes.io/name":     _simple_app_name
	"app.kubernetes.io/instance": #release.Name
}
-- expected/values.cue --
// Code generated by helm2cue; DO NOT EDIT.

package simple_app

#values: {
	env:          *"development" | bool | number | string | null
	debug?:       bool | number | string | null
	replicaCount: *1 | bool | number | string | null
	image?: {
		repository!: bool | number | string | null
		tag!:        bool | number | string | null
		pullPolicy:  *"IfNotPresent" | bool | number | string | null
		...
	}
	ports!: [...{
		name!:          bool | number | string | null
		containerPort!: bool | number | string | null
		...
	}]
	service?: {
		type: *"ClusterIP" | bool | number | string | null
		port: *80 | bool | number | string | null
		...
	}
	...
}
-- expected/data.cue --
// Code generated by helm2cue; DO NOT EDIT.

@extern(embed)

package simple_app

#values:  _ @embed(file=values.yaml)
#release: _ @embed(file=release.yaml)
#release: {
	Name: _ @tag(release_name)
}
-- expected/context.cue --
// Code generated by helm2cue; DO NOT EDIT.

package simple_app

#chart: {
	Name:       "simple-app"
	Version:    "0.1.0"
	AppVersion: "1.0.0"
}
#release: {
	Name:      _
	Namespace: *"default" | string
	Service:   *"Helm" | string
	IsUpgrade: *false | bool
	IsInstall: *true | bool
	Revision:  *1 | int
}
-- expected/deployment.cue --
// Code generated by helm2cue; DO NOT EDIT.

package simple_app

deployment: {
	apiVersion: "apps/v1"
	kind:       "Deployment"
	metadata: {
		name:   _simple_app_fullname
		labels: _simple_app_labels
	}
	spec: {
		replicas: #values.replicaCount
		selector: {
			matchLabels: _simple_app_selectorLabels
		}
		template: {
			metadata: {
				labels: _simple_app_selectorLabels
			}
			spec: {
				containers: [
					{
						name:            _simple_app_name
						image:           "\(#values.image.repository):\(#values.image.tag)"
						imagePullPolicy: #values.image.pullPolicy
						ports: [
							for _, _range0 in #values.ports {
								name:          _range0.name
								containerPort: _range0.containerPort
							},
						]
					},
				]
			}
		}
	}
}
-- expected/service.cue --
// Code generated by helm2cue; DO NOT EDIT.

package simple_app

service: {
	apiVersion: "v1"
	kind:       "Service"
	metadata: {
		name:   _simple_app_fullname
		labels: _simple_app_labels
	}
	spec: {
		type: #values.service.type
		ports: [
			{
				port:       #values.service.port
				targetPort: "http"
				protocol:   "TCP"
				name:       "http"
			},
		]
		selector: _simple_app_selectorLabels
	}
}
-- expected/configmap.cue --
// Code generated by helm2cue; DO NOT EDIT.

package simple_app

configmap: {
	apiVersion: "v1"
	kind:       "ConfigMap"
	metadata: {
		name:   _simple_app_fullname
		labels: _simple_app_labels
	}
	data: {
		environment: "\(#values.env)"
		if (_nonzero & {#arg: #values.debug, _}) {
			logLevel: "debug"
		}
		if !(_nonzero & {#arg: #values.debug, _}) {
			logLevel: "info"
		}
	}
}
-- expected/results.cue --
// Code generated by helm2cue; DO NOT EDIT.

package simple_app

results: [
	configmap,
	deployment,
	service,
]
-- expected/values.yaml --
replicaCount: 3

image:
  repository: nginx
  tag: "1.25"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 80

ports:
  - name: http
    containerPort: 80
  - name: https
    containerPort: 443

env: production
debug: false
-- expected/release.yaml --
