# Validation message helper whose body contains "component: errorKey"
# followed by indented text lines. The converter mis-parses this as
# YAML structure, producing mixed fields and bare strings (invalid CUE).
# https://github.com/cue-exp/helm2cue/issues/41
exec helm2cue chart chartdir outdir
cmp stderr stderr.golden
cmp outdir/helpers.cue expected/helpers.cue

-- chartdir/Chart.yaml --
apiVersion: v2
name: test-app
version: 0.1.0
-- chartdir/values.yaml --
cloneRepo:
  enabled: false
  repository: ""
  branch: ""
-- chartdir/templates/_helpers.tpl --
{{- define "test.validateValues.cloneRepo" -}}
{{- if and .Values.cloneRepo.enabled (not .Values.cloneRepo.repository) -}}
test: cloneRepo
    When enabling cloning a repo, both
    the repository and branch must be provided.
{{- end -}}
{{- end -}}
-- chartdir/templates/test.yaml --
apiVersion: v1
kind: ConfigMap
metadata:
  name: test
data:
  key: value
-- stderr.golden --
converted 1/1 templates from test-app
-- expected/helpers.cue --
// Code generated by helm2cue; DO NOT EDIT.

package test_app

import "struct"

// _nonzero tests whether a value is "truthy" (non-zero,
// non-empty, non-null), matching Go text/template semantics.
// A natural candidate for a CUE standard library builtin.
_nonzero: {
	#arg?: _
	[if #arg != _|_ {
		[
			if (#arg & int) != _|_ {#arg != 0},
			if (#arg & string) != _|_ {#arg != ""},
			if (#arg & float) != _|_ {#arg != 0.0},
			if (#arg & bool) != _|_ {#arg},
			if (#arg & [...]) != _|_ {len(#arg) > 0},
			if (#arg & {...}) != _|_ {(#arg & struct.MaxFields(0)) == _|_},
			false,
		][0]
	}, false][0]
}

_test_validateValues_cloneRepo: {
	if (_nonzero & {#arg: #values.cloneRepo.enabled, _}) && !(_nonzero & {#arg: #values.cloneRepo.repository, _}) {
		test: "cloneRepo"
		"When enabling cloning a repo, both"
		"the repository and branch must be provided."
	}
}
