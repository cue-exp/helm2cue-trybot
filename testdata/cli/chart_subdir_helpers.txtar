# Chart with .tpl helpers in template subdirectories.
# Without recursive walking, helpers defined in e.g.
# templates/operator/_operator.tpl would be silently missed.
exec helm2cue chart chartdir outdir
stderr 'converted 1/1 templates'
cmp outdir/helpers.cue expected/helpers.cue
cmp outdir/deployment.cue expected/deployment.cue

-- chartdir/Chart.yaml --
apiVersion: v2
name: subdir-helpers
description: Chart with helpers in template subdirectories
version: 0.1.0
appVersion: "1.0.0"
-- chartdir/values.yaml --
replicaCount: 1
-- chartdir/templates/_helpers.tpl --
{{- define "subdir-helpers.name" -}}
{{- .Chart.Name | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{- define "subdir-helpers.fullname" -}}
{{- printf "%s-%s" .Release.Name .Chart.Name | trunc 63 | trimSuffix "-" -}}
{{- end -}}
-- chartdir/templates/operator/_operator.tpl --
{{- define "subdir-helpers.operator.labels" -}}
app.kubernetes.io/component: operator
app.kubernetes.io/name: {{ include "subdir-helpers.name" . }}
{{- end -}}
-- chartdir/templates/deployment.yaml --
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "subdir-helpers.fullname" . }}
  labels:
    {{- include "subdir-helpers.operator.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount | default 1 }}
  selector:
    matchLabels:
      app: {{ include "subdir-helpers.name" . }}
  template:
    metadata:
      labels:
        app: {{ include "subdir-helpers.name" . }}
    spec:
      containers:
        - name: {{ include "subdir-helpers.name" . }}
          image: nginx:latest
-- expected/helpers.cue --
// Code generated by helm2cue; DO NOT EDIT.

package subdir_helpers

import "strings"

// _trunc truncates a string to N runes, matching Helm's
// trunc semantics where shorter strings pass through.
// A natural candidate for a CUE standard library builtin.
_trunc: {
	#in: string
	#n:  int
	_r:  len(strings.Runes(#in))
	out: string
	if _r <= #n {out: #in}
	if _r > #n {out: strings.SliceRunes(#in, 0, #n)}
}

_subdir_helpers_fullname: {
	strings.TrimSuffix((_trunc & {#in: "\(#release.Name)-\(#chart.Name)", #n: 63}).out, "-")
}
_subdir_helpers_name: {
	strings.TrimSuffix((_trunc & {#in: #chart.Name, #n: 63}).out, "-")
}
_subdir_helpers_operator_labels: {
	"app.kubernetes.io/component": "operator"
	"app.kubernetes.io/name":      _subdir_helpers_name
}
-- expected/deployment.cue --
// Code generated by helm2cue; DO NOT EDIT.

package subdir_helpers

deployment: {
	apiVersion: "apps/v1"
	kind:       "Deployment"
	metadata: {
		name:   _subdir_helpers_fullname
		labels: _subdir_helpers_operator_labels
	}
	spec: {
		replicas: #values.replicaCount
		selector: {
			matchLabels: {
				app: _subdir_helpers_name
			}
		}
		template: {
			metadata: {
				labels: {
					app: _subdir_helpers_name
				}
			}
			spec: {
				containers: [
					{
						name:  _subdir_helpers_name
						image: "nginx:latest"
					},
				]
			}
		}
	}
}
