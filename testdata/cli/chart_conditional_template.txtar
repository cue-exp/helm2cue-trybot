# Template entirely guarded by top-level if produces valid results.cue
# references. Regression test for https://github.com/cue-exp/helm2cue/issues/24
exec helm2cue chart chartdir outdir
cmp stderr stderr.golden
cmp outdir/hpa.cue expected/hpa.cue
cmp outdir/results.cue expected/results.cue

-- chartdir/Chart.yaml --
apiVersion: v2
name: test-app
version: 0.1.0
-- chartdir/values.yaml --
autoscaling:
  enabled: false
service:
  port: 80
-- chartdir/templates/service.yaml --
apiVersion: v1
kind: Service
metadata:
  name: test
spec:
  ports:
  - port: {{ .Values.service.port }}
-- chartdir/templates/hpa.yaml --
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: test
spec:
  minReplicas: 1
  maxReplicas: 10
{{- end }}
-- stderr.golden --
converted 2/2 templates from test-app
-- expected/hpa.cue --
// Code generated by helm2cue; DO NOT EDIT.

package test_app

hpa: [
	if (_nonzero & {#arg: #values.autoscaling.enabled, _}) {
		{
			apiVersion: "autoscaling/v2"
			kind:       "HorizontalPodAutoscaler"
			metadata: {
				name: "test"
			}
			spec: {
				minReplicas: 1
				maxReplicas: 10
			}
		}
	},
]
-- expected/results.cue --
// Code generated by helm2cue; DO NOT EDIT.

package test_app

import "list"

results: list.FlattenN([
	hpa,
	service,
], 1)
